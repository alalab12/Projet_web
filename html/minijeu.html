<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Construis ta ville</title>
  <link rel="stylesheet" href="../css/style.css">


</head>

<body class="jeu">

  <header>
        <img src="../img/logo2.png" alt="ODD9 Logo">
        
        <div class="menu-toggle">‚ò∞</div>
        <nav>
            <ul>
                <li><a href="accueil.html">Accueil</a></li>
                <li><a href="solutions.html">Solutions</a></li>
                <li><a href="defis.html">D√©fis</a></li>
                <li><a href="minijeu.html">Mini jeu</a></li>
                <li><a href="quizz.html">Quizz</a></li>
                <li><a href="apropos.html">√Ä propos</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </header>


  <h1>CONSTRUIS TA VILLE</h1>
  <div class="background-image"></div>
  <p>Glisse un b√¢timent sur la grille</p>
  <div class="toolbar">
    
    <button draggable="true" ondragstart="onDragStart(event, 'usine')"><img src="../img/usine.png" alt="hopital"></button>
    <button draggable="true" ondragstart="onDragStart(event, 'route2')"><img src="../img/route2.png" alt="route"></button>
    <button draggable="true" ondragstart="onDragStart(event, 'route1')"><img src="../img/route1.png" alt="route"></button>
    <button draggable="true" ondragstart="onDragStart(event, 'parc')"><img src="../img/parc.png" alt="parc"></button>
    <button draggable="true" ondragstart="onDragStart(event, 'maison')"><img src="../img/house.png" alt="maison"></button>
    <button draggable="true" ondragstart="onDragStart(event, 'ecole')"><img src="../img/school.png" alt="school"></button>
    <button draggable="true" ondragstart="onDragStart(event, 'magasin')"  ><img src="../img/magasin.png" alt="magasin"></button>
    <button draggable="true" ondragstart="onDragStart(event, 'hoptial')" ><img src="../img/hopital.png" alt="hopital"></button>
  </div>

  <canvas id="gameCanvas" width="600" height="600"></canvas>

  <div class="scores">
    Environnement : <span id="env">0</span> 
    √âconomie : <span id="eco">0</span> 
    Social : <span id="social">0</span> 
    Efficience : <span id="efficience">0%</span>
  </div>

  <div class="population">
    Population : <span id="population">0</span> 
    Nourris : <span id="nourris">0</span> 
    √âduqu√©s : <span id="eduques">0</span> 
    Soign√©s : <span id="soignes">0</span>
  </div>

  <button class="finish" onclick="finish()"> Terminer ma ville</button>

  <div id="result"></div>

  <footer>
        <p>&copy; 2025 ODD9 - Industrie, Innovation et Infrastructure | R√©alis√© par Aude LABAT et Lucie Ozgullu
        </p>
        <nav>
            <ul>
                <li><a href="../html/accueil.html">Accueil</a></li>
                <li><a href="../html/apropos.html">√Ä propos</a></li>
                <li><a href="../html/contact.html">Contact</a></li>
            </ul>
        </nav>
    </footer>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const cellSize = 120;
  const gridSize = 5;
  const grid = Array.from({ length: gridSize }, () => Array(gridSize).fill(null));

  const scores = { env: 0, eco: 0, social: 0 };

  const buildings = {
    usine: { imgSrc: "../img/usine.png", env: 2, eco: 3, social: -1, workersNeeded: 20 },
    route2: { imgSrc: "../img/route2.png", env: -2, eco: 3, social: -1 },
    route1: { imgSrc: "../img/route1.png", env: -1, eco: 1, social: 0 },
    parc: { imgSrc: "../img/parc.png", env: 3, eco: 0, social: 2 },
    maison: { imgSrc: "../img/house.png", env: 1, eco: 0, social: 2, inhabitants: 4 },
    ecole: { imgSrc: "../img/school.png", env: 0, eco: 0, social: 3, educates: 40 },
    magasin: { imgSrc: "../img/magasin.png", env: 0, eco: 2, social: 1, feeds: 60 },
    hopital: { imgSrc: "../img/hopital.png", env: 0, eco: 0, social: 3, heals: 30 }
  };

  // Pr√©chargement des images
  const imagesCache = {};
  for (const key in buildings) {
    const img = new Image();
    img.src = buildings[key].imgSrc;
    imagesCache[key] = img;
  }

  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('nav');

    toggle.addEventListener('click', function () {
        nav.classList.toggle('active');
    });

    document.querySelectorAll('nav a').forEach(link => {
        link.addEventListener('click', () => {
            nav.classList.remove('active');
        });
    });
  });

  function drawGrid() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for(let y=0; y<gridSize; y++){
      for(let x=0; x<gridSize; x++){
        ctx.strokeStyle = "#555";
        ctx.strokeRect(x*cellSize, y*cellSize, cellSize, cellSize);
        const b = grid[y][x];
        if(b){
          const type = Object.keys(buildings).find(key => buildings[key] === b);
          const img = imagesCache[type];
          if (img.complete) {
            ctx.drawImage(img, x * cellSize, y * cellSize, cellSize, cellSize);
          } else {
            img.onload = () => drawGrid(); // redraw once image is loaded
          }
        }
      }
    }
  }

  function onDragStart(event, type){
    event.dataTransfer.setData("buildingType", type);
  }

  canvas.addEventListener("dragover", e => e.preventDefault());

  canvas.addEventListener("drop", e => {
    e.preventDefault();
    const type = e.dataTransfer.getData("buildingType");
    if(!type) return;
    const building = buildings[type];
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left)/cellSize);
    const y = Math.floor((e.clientY - rect.top)/cellSize);
    if(x>=0 && x<gridSize && y>=0 && y<gridSize && !grid[y][x]){
      grid[y][x] = building;
      drawGrid();
      updateScores();
    }
  });

  function updateScores(){
    scores.env = 0; scores.eco=0; scores.social=0;
    let population = 0, nourris = 0, eduques = 0, soignes = 0;
    for(let y=0; y<gridSize; y++){
      for(let x=0; x<gridSize; x++){
        const b = grid[y][x];
        if(b){
          scores.env += b.env || 0;
          scores.eco += b.eco || 0;
          scores.social += b.social || 0;
          population += b.inhabitants || 0;
          nourris += b.feeds || 0;
          eduques += b.educates || 0;
          soignes += b.heals || 0;
        }
      }
    }

    document.getElementById("env").textContent = scores.env;
    document.getElementById("eco").textContent = scores.eco;
    document.getElementById("social").textContent = scores.social;
    document.getElementById("population").textContent = population;
    document.getElementById("nourris").textContent = `${Math.min(nourris, population)}/${population}`;
    document.getElementById("eduques").textContent = `${Math.min(eduques, population)}/${population}`;
    document.getElementById("soignes").textContent = `${Math.min(soignes, population)}/${population}`;
  }

  function getConnectedBuildings(){
    let visited = Array.from({ length:gridSize }, () => Array(gridSize).fill(false));
    let connected = Array.from({ length:gridSize }, () => Array(gridSize).fill(false));
    let stack = [];
    for(let y=0; y<gridSize; y++){
      for(let x=0; x<gridSize; x++){
        const b = grid[y][x];
        if(b && (b === buildings.route1 || b === buildings.route2)){
          stack.push([x,y]);
          visited[y][x] = true;
          connected[y][x] = true;
        }
      }
    }
    while(stack.length > 0){
      const [x,y] = stack.pop();
      for(let [nx, ny] of [[x+1,y],[x-1,y],[x,y+1],[x,y-1]]){
        if(nx>=0 && nx<gridSize && ny>=0 && ny<gridSize){
          if(grid[ny][nx] && !visited[ny][nx]){
            visited[ny][nx] = true;
            connected[ny][nx] = true;
            stack.push([nx, ny]);
          }
        }
      }
    }
    return connected;
  }

  function calculateEfficiency(){
    const connected = getConnectedBuildings();
    let totalInhabitants = 0;
    let totalWorkersNeeded = 0;
    let buildingsCount = 0;
    let connectedBuildingsCount = 0;

    for(let y=0; y<gridSize; y++){
      for(let x=0; x<gridSize; x++){
        const b = grid[y][x];
        if(b){
          buildingsCount++;
          if(b.inhabitants) totalInhabitants += b.inhabitants;
          if(b.workersNeeded) totalWorkersNeeded += b.workersNeeded;
          if(connected[y][x]) connectedBuildingsCount++;
        }
      }
    }

    let workForceOk = totalInhabitants >= totalWorkersNeeded;
    let efficienceRate = buildingsCount ? Math.round((connectedBuildingsCount / buildingsCount)*100) : 0;
    if(!workForceOk) efficienceRate = Math.max(0, efficienceRate - 20);
    return efficienceRate;
  }

  canvas.addEventListener("contextmenu", function(e) {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left)/cellSize);
  const y = Math.floor((e.clientY - rect.top)/cellSize);
  if(x >= 0 && x < gridSize && y >= 0 && y < gridSize && grid[y][x]) {
    grid[y][x] = null;
    drawGrid();
    updateScores();
  }
});



  function finish(){
    updateScores();
    const efficience = calculateEfficiency();
    document.getElementById("efficience").textContent = efficience + "%";

    const population = parseInt(document.getElementById("population").textContent);
    const nourris = parseInt(document.getElementById("nourris").textContent.split("/")[0]);
    const eduques = parseInt(document.getElementById("eduques").textContent.split("/")[0]);
    const soignes = parseInt(document.getElementById("soignes").textContent.split("/")[0]);

    let message = "";
    if(scores.env >= 10 && scores.eco >= 10 && scores.social >= 10 && efficience >= 50 && nourris >= population && eduques >= population && soignes >= population){
      message = "üèÜ F√©licitations ! Ta ville est √©quilibr√©e, efficiente et durable !";
    } else {
      message = "Ta ville n'est pas encore durable. Travaille sur : ";
      if(scores.env < 10) message += "environnement, ";
      if(scores.eco < 10) message += "√©conomie, ";
      if(scores.social < 10) message += "aspect social, ";
      if(efficience < 50) message += "efficience, ";
      if(nourris < population) message += "nourriture, ";
      if(eduques < population) message += "√©ducation, ";
      if(soignes < population) message += "sant√©, ";
    }

    document.getElementById("result").textContent = message.replace(/, $/, ".");
  }

  drawGrid();
</script>

</body>
</html>
